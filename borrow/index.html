<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€Ÿé‚„æ›¸ç®¡ç†ç³»çµ±</title>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* ç®¡ç†ä»‹é¢å°ˆç”¨æ¨£å¼ */
        .admin-panel { display: none; } /* é è¨­éš±è—ï¼Œç™»å…¥å¾Œé¡¯ç¤º */
        .login-panel { text-align: center; margin-top: 50px; }
        .input-group { margin: 20px 0; display: flex; gap: 10px; }
        .input-field { flex: 1; padding: 12px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 8px; }
        .btn { padding: 10px 20px; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-danger { background: var(--error-color); color: white; }
        
        .card { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .user-info { border-left: 5px solid var(--accent-color); }
        .overdue-alert { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-top: 10px; }
        
        .cart-list { list-style: none; padding: 0; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }
        .cart-remove { color: red; cursor: pointer; padding: 5px; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“š å€Ÿé‚„æ›¸ç®¡ç†ç³»çµ±</h1>
            <div id="user-status" style="font-size: 0.8rem; margin-top: 5px;"></div>
        </header>

        <!-- ç™»å…¥å€å¡Š -->
        <div id="login-section" class="login-panel">
            <p>è«‹ç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ</p>
            <div id="g_id_onload"
                 data-client_id="YOUR_GOOGLE_CLIENT_ID" 
                 data-callback="handleCredentialResponse"
                 data-auto_select="true">
            </div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>

        <!-- ä¸»æ“ä½œä»‹é¢ -->
        <div id="admin-section" class="admin-panel content">
            
            <!-- æƒæè¼¸å…¥æ¡† -->
            <div class="input-group">
                <input type="text" id="barcode-input" class="input-field" placeholder="è«‹æƒææˆ–è¼¸å…¥æ¢ç¢¼..." autofocus>
                <button class="btn btn-primary" onclick="manualSubmit()">ğŸ”</button>
            </div>

            <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
            <div id="message-area"></div>

            <!-- ä½¿ç”¨è€…è³‡è¨Šå¡ç‰‡ -->
            <div id="user-card" class="card user-info" style="display: none;">
                <h3>ğŸ‘¤ ä½¿ç”¨è€…è³‡è¨Š</h3>
                <div id="user-details"></div>
            </div>

            <!-- å¾…å€Ÿé–±æ¸…å–® -->
            <div id="cart-card" class="card" style="display: none;">
                <h3>ğŸ“š å¾…å€Ÿé–±æ¸…å–® (<span id="cart-count">0</span>)</h3>
                <ul id="cart-list" class="cart-list"></ul>
                <button id="btn-confirm-borrow" class="btn btn-primary" style="width: 100%; margin-top: 15px;">âœ… ç¢ºèªå€Ÿé–±</button>
            </div>

            <button onclick="resetSystem()" class="btn" style="width: 100%; margin-top: 20px; background: #eee;">ğŸ”„ é‡ç½® / ä¸‹ä¸€ä½</button>
        </div>
    </div>

    <!-- é‚„æ›¸ç¢ºèªè¦–çª— -->
    <div id="return-modal" class="modal">
        <div class="modal-content">
            <h3>æ­¸é‚„æ›¸ç±ç¢ºèª</h3>
            <p id="return-book-info" style="margin: 15px 0; text-align: left; line-height: 1.6;"></p>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="confirmReturn()">âœ… ç¢ºèªæ­¸é‚„</button>
                <button class="btn btn-danger" onclick="closeModal()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const API_BASE = 'https://lib-api.ä½ çš„å°ˆæ¡ˆ.workers.dev/api'; // æ›¿æ›ç‚ºä½ çš„ Worker ç¶²å€
        let authToken = '';
        let currentUser = null;
        let cart = [];
        let pendingReturnCode = null;

        // 1. Google ç™»å…¥å›èª¿
        function handleCredentialResponse(response) {
            authToken = response.credential;
            verifyAdmin(authToken);
        }

        async function verifyAdmin(token) {
            try {
                const res = await fetch(`${API_BASE}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.isAdmin) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('admin-section').style.display = 'block';
                    document.getElementById('user-status').innerText = `ç®¡ç†å“¡ï¼š${data.email}`;
                    document.getElementById('barcode-input').focus();
                } else {
                    alert('æ¬Šé™ä¸è¶³');
                }
            } catch (e) {
                alert('ç™»å…¥é©—è­‰å¤±æ•—');
                console.error(e);
            }
        }

        // 2. æ¢ç¢¼è¼¸å…¥ç›£è½
        const input = document.getElementById('barcode-input');
        input.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') processBarcode(input.value);
        });
        
        function manualSubmit() { processBarcode(input.value); }

        async function processBarcode(code) {
            code = code.trim();
            if (!code) return;
            input.value = ''; // æ¸…ç©º

            // åˆ¤æ–·é‚è¼¯
            if (code.length === 8) {
                await fetchUser(code);
            } else if (code.length >= 10) {
                await fetchBook(code);
            } else {
                showMessage('âŒ ç„¡æ•ˆçš„æ¢ç¢¼æ ¼å¼', 'error');
            }
        }

        // 3. å–å¾—ä½¿ç”¨è€…
        async function fetchUser(cardCode) {
            showMessage('â³ æŸ¥è©¢ä½¿ç”¨è€…ä¸­...', 'info');
            const res = await apiCall('/user/info', { card_code: cardCode });
            
            if (res.success) {
                currentUser = res.data;
                renderUser();
                showMessage(`âœ… è®€å–æˆåŠŸï¼š${currentUser.name}`, 'success');
            } else {
                showMessage(`âŒ ${res.message}`, 'error');
            }
        }

        // 4. å–å¾—æ›¸ç±
        async function fetchBook(code) {
            showMessage('â³ æŸ¥è©¢æ›¸ç±ä¸­...', 'info');
            const res = await apiCall('/book/check', { code: code });
            
            if (!res.success) {
                showMessage(`âŒ ${res.message}`, 'error');
                return;
            }

            const book = res.data;

            // é‚è¼¯ A: æ›¸ç±å¤–å€Ÿä¸­ -> è·³å‡ºé‚„æ›¸è¦–çª—
            if (book.status === 'å¤–å€Ÿ') {
                pendingReturnCode = book.code;
                showReturnModal(book);
                return;
            }

            // é‚è¼¯ B: æ›¸ç±åœ¨åº«
            if (!currentUser) {
                showMessage('âš ï¸ è«‹å…ˆæƒæä½¿ç”¨è€…æ¢ç¢¼å†å€Ÿæ›¸', 'error');
                return;
            }

            // æª¢æŸ¥é€¾æœŸ
            if (currentUser.overdue) {
                showMessage('â›” è©²ä½¿ç”¨è€…æœ‰é€¾æœŸæ›¸ç±ï¼Œç„¡æ³•å€Ÿé–±', 'error');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦å·²åœ¨è³¼ç‰©è»Š
            if (cart.find(c => c.code === book.code)) {
                showMessage('âš ï¸ æ­¤æ›¸å·²åœ¨æ¸…å–®ä¸­', 'error');
                return;
            }

            // æª¢æŸ¥é¡åº¦
            const currentTotal = currentUser.already_borrowed + cart.length;
            if (currentTotal >= currentUser.max) {
                showMessage('â›” è¶…å‡ºå€Ÿé–±ä¸Šé™', 'error');
                return;
            }

            // åŠ å…¥è³¼ç‰©è»Š
            cart.push(book);
            renderCart();
            showMessage(`âœ… åŠ å…¥æ¸…å–®ï¼š${book.isbn}`, 'success');
        }

        // 5. åŸ·è¡Œå€Ÿé–±
        document.getElementById('btn-confirm-borrow').addEventListener('click', async () => {
            if (!currentUser || cart.length === 0) return;
            
            if (!confirm(`ç¢ºèªå€Ÿå‡º ${cart.length} æœ¬æ›¸ç±çµ¦ ${currentUser.name}ï¼Ÿ`)) return;

            const res = await apiCall('/borrow/confirm', {
                user_num: currentUser.user_num,
                card_code: currentUser.card_code,
                books: cart.map(b => b.code)
            });

            if (res.success) {
                alert(`å€Ÿé–±æˆåŠŸï¼\næ‡‰é‚„æ—¥æœŸï¼š${res.data.due_date}`);
                resetSystem();
            } else {
                alert(`å€Ÿé–±å¤±æ•—ï¼š${res.message}`);
            }
        });

        // 6. åŸ·è¡Œé‚„æ›¸
        async function confirmReturn() {
            if (!pendingReturnCode) return;
            
            const res = await apiCall('/return/confirm', { code: pendingReturnCode });
            closeModal();

            if (res.success) {
                let msg = `âœ… é‚„æ›¸æˆåŠŸ\nå€Ÿé–±äººï¼š${res.data.borrower_id}`;
                if (currentUser && currentUser.user_num === res.data.borrower_id) {
                    // å¦‚æœå‰›å¥½æ˜¯ç•¶å‰æ“ä½œçš„ä½¿ç”¨è€…ï¼Œåˆ·æ–°ä»–çš„è³‡è¨Š
                    fetchUser(currentUser.card_code); 
                }
                alert(msg);
            } else {
                alert(`é‚„æ›¸å¤±æ•—ï¼š${res.message}`);
            }
        }

        // --- ç•«é¢æ¸²æŸ“è¼”åŠ© ---
        function renderUser() {
            const div = document.getElementById('user-card');
            const details = document.getElementById('user-details');
            div.style.display = 'block';
            
            let overdueHtml = '';
            if (currentUser.overdue) {
                overdueHtml = `
                    <div class="overdue-alert">
                        <strong>âš ï¸ é€¾æœŸè­¦å‘Š</strong><br>
                        ${currentUser.overdue_books.map(b => `æ›¸ç± ${b.borrow_num} é€¾æœŸ ${b.days} å¤©`).join('<br>')}
                    </div>`;
            }

            details.innerHTML = `
                <p><strong>å§“åï¼š</strong>${currentUser.name}</p>
                <p><strong>å·²å€Ÿï¼š</strong>${currentUser.already_borrowed} / ${currentUser.max}</p>
                ${overdueHtml}
            `;
        }

        function renderCart() {
            const div = document.getElementById('cart-card');
            const list = document.getElementById('cart-list');
            const count = document.getElementById('cart-count');
            
            if (cart.length > 0) {
                div.style.display = 'block';
                list.innerHTML = cart.map((book, idx) => `
                    <li class="cart-item">
                        <span>${book.isbn} <br><small>${book.location}</small></span>
                        <span class="cart-remove" onclick="removeFromCart(${idx})">âŒ</span>
                    </li>
                `).join('');
                count.innerText = cart.length;
            } else {
                div.style.display = 'none';
            }
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            renderCart();
        }

        function showReturnModal(book) {
            const modal = document.getElementById('return-modal');
            const info = document.getElementById('return-book-info');
            info.innerHTML = `
                <strong>æ›¸ç±ï¼š</strong>${book.isbn}<br>
                <strong>å€Ÿé–±äººï¼š</strong>${book.borrowed_info.borrower}<br>
                <strong>å€Ÿå‡ºæ—¥ï¼š</strong>${book.borrowed_info.borrow_date}<br>
                <strong>æ‡‰é‚„æ—¥ï¼š</strong>${book.borrowed_info.due_date}
            `;
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('return-modal').style.display = 'none';
            pendingReturnCode = null;
        }

        function showMessage(msg, type) {
            const area = document.getElementById('message-area');
            const color = type === 'error' ? 'red' : 'green';
            area.innerHTML = `<p style="color:${color}; font-weight:bold; padding:10px;">${msg}</p>`;
        }

        function resetSystem() {
            currentUser = null;
            cart = [];
            document.getElementById('user-card').style.display = 'none';
            document.getElementById('cart-card').style.display = 'none';
            document.getElementById('message-area').innerHTML = '';
            document.getElementById('barcode-input').value = '';
            document.getElementById('barcode-input').focus();
        }

        async function apiCall(endpoint, body) {
            try {
                const res = await fetch(API_BASE + endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(body)
                });
                return await res.json();
            } catch (e) {
                return { success: false, message: 'ç¶²è·¯éŒ¯èª¤' };
            }
        }
    </script>
</body>
</html>
