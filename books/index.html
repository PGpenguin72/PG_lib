<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>書籍詳細資訊</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* 書籍詳情頁專用樣式 */
        .book-header { text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .book-title { font-size: 1.4rem; font-weight: bold; color: var(--primary-color); margin-bottom: 8px; }
        .book-author { color: #666; font-size: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>查詢結果</h1>
        </header>
        <div class="content" id="app">
            <div class="loading">
                <p>資料讀取中...</p>
            </div>
        </div>
    </div>

    <script>
        // ✅ 你的 Cloudflare Worker API 網址 (已設定好)
        const API_BASE = 'https://lib-api.tu28291797.workers.dev/api'; 

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            if (!code) {
                renderError('無效的連結：缺少書籍代碼');
                return;
            }

            fetchBookInfo(code);
        });

        async function fetchBookInfo(code) {
            try {
                // 呼叫 Worker 的 API
                const response = await fetch(`${API_BASE}/books?code=${code}`);
                const json = await response.json();

                if (json.success) {
                    renderBook(json.data);
                } else {
                    renderError(json.message);
                }
            } catch (error) {
                console.error(error);
                renderError('無法連線到資料庫，請稍後再試。');
            }
        }

        function renderBook(data) {
            const app = document.getElementById('app');
            const isBorrowed = data.status === '外借';
            
            // 狀態顯示邏輯
            const statusHtml = isBorrowed 
                ? `<span class="status-badge status-out">❌ 外借</span>` 
                : `<span class="status-badge status-in">✅ 在庫 (可借閱)</span>`;

            // 處理標題 (如果 Google Sheet 沒填 title 就顯示未命名)
            const title = data.title || '未命名書籍';
            const author = data.author || '未知作者';
            
            // 處理價格顯示 (如果沒有價格顯示 - )
            const displayFixedPrice = data.fixed_price ? `${data.fixed_price} 元` : '-';

            // 構建完整 HTML (包含出版社、日期、分類等詳細資料)
            let html = `
                <div class="book-header">
                    <div class="book-title">${title}</div>
                    <div class="book-author">作者：${author}</div>
                </div>

                <div class="info-group">
                    <div class="info-title">基本資料</div>
                    <div class="data-row"><span class="label">出版社</span><span class="value">${data.publisher}</span></div>
                    <div class="data-row"><span class="label">出版日</span><span class="value">${data.pub_date}</span></div>
                    <div class="data-row"><span class="label">分類</span><span class="value">${data.category}</span></div>
                    <div class="data-row"><span class="label">刷次</span><span class="value">${data.edition}</span></div>
                    <div class="data-row"><span class="label">ISBN</span><span class="value">${data.isbn}</span></div>
                </div>

                <div class="info-group">
                    <div class="info-title">館藏資訊</div>
                    <div class="data-row"><span class="label">登錄號</span><span class="value">${data.book_id}</span></div>
                    <div class="data-row"><span class="label">位置</span><span class="value">${data.location}</span></div>
                    <div class="data-row"><span class="label">庫存</span><span class="value">${data.stock}</span></div>
                    <div class="data-row"><span class="label">定價</span><span class="value">${displayFixedPrice}</span></div>
                    <div class="data-row"><span class="label">狀態</span><span class="value">${statusHtml}</span></div>
                </div>
            `;

            // 如果外借中，顯示借閱資訊 (已經由後端脫敏)
            if (isBorrowed && data.borrowed_info) {
                const info = data.borrowed_info;
                // 計算是否逾期
                const isOverdue = new Date() > new Date(info.due_date);
                const dateStyle = isOverdue ? 'color: var(--error-color); font-weight:bold;' : '';

                html += `
                    <div class="info-group">
                        <div class="info-title">借閱狀態</div>
                        <div class="data-row"><span class="label">借閱人</span><span class="value">${info.borrower}</span></div>
                        <div class="data-row"><span class="label">借出日</span><span class="value">${info.borrow_date}</span></div>
                        <div class="data-row"><span class="label">應還日</span><span class="value" style="${dateStyle}">${info.due_date}</span></div>
                    </div>
                `;
            }

            app.innerHTML = html;
        }

        function renderError(msg) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="error-msg">
                    <h3>⚠️ 查詢失敗</h3>
                    <p>${msg}</p>
                    <br>
                    <a href="/" style="color: #666;">回首頁</a>
                </div>
            `;
        }
    </script>
</body>
</html>
